// Generated by CoffeeScript 1.4.0
(function() {
  var SOCKET_TEMPLATE, STYLE_TEMPLATE, createServer, fs, http, insertSocket, insertStyle, insertTempl, io, path, renderDir, res500, types, url, watcher;

  http = require("http");

  io = require("socket.io");

  url = require("url");

  fs = require("fs");

  path = require("path");

  types = require("./mime").types;

  watcher = require("watch-tree-maintained").watchTree(".", {
    "ignore": "^\..*|~$|\\.swp$"
  });

  SOCKET_TEMPLATE = "<script src=\"/socket.io/socket.io.js\"></script>\n<script>\n    var socket = io.connect('http://localhost');\n    socket.on('reload', function (data) {\n        window.location.reload();\n    });\n</script>";

  STYLE_TEMPLATE = "<style type=\"text/css\">\n	ul{padding:5px 8px; background:#F8F8F8; margin:5px; border: 1px solid #CACACA; border-radius:3px; box-shadow:0 0 5px #ccc;}\n	ul li{list-style-type:none; border-bottom:1px solid #eee; padding:3px;}\n	ul li a{color:#4183C4; text-decoration:none}\n	ul li a:hover{text-decoration:underline}\n	ul li span{background-image:url(http://pic.yupoo.com/island205/CjJzay6Y/BaDLi.png); display:inline-block; width:20px; height:14px; margin:0 3px}\n	ul li .folder{}\n	ul li .file{ background-position-y:18px;}\n	.subdir ul{display: none;box-shadow:0 0 5px #ccc inset;}\n</style>\n	<script>\nvar subdirs = document.getElementsByClassName('subdir');\nvar l = subdirs.length;\nfor(var i = 0;i < l;i ++) {\n	(function(index){\n		subdirs[i].addEventListener('click',function(){\n			var folder = this.getElementsByTagName(\"ul\")[0];\n			if(folder.style.display == 'none' || !folder.style.getPropertyValue('display')) {\n			folder.style.display = 'block';\n			return;\n			}\n			if(folder.style.display == 'block') {\n				folder.style.display = 'none';\n				return;\n			}\n		})\n	})(i)\n}\n	</script>";

  insertTempl = function(file, templ) {
    var index;
    index = file.indexOf("</body>");
    if (index === -1) {
      return file += templ.join('');
    } else {
      return file = file.slice(0, index) + templ.join('') + file.slice(index);
    }
  };

  insertSocket = function(file) {
    return insertTempl(file, [SOCKET_TEMPLATE]);
  };

  insertStyle = function(file) {
    return insertTempl(file, [STYLE_TEMPLATE]);
  };

  res500 = function(err, res) {
    res.writeHead(500, {
      "Content-Type": "text/plain"
    });
    return res.end(err);
  };

  renderDir = function(realPath, files) {
    var file, html, _files, _i, _len, _path;
    if (realPath[realPath.length - 1] !== "/") {
      realPath += "/";
    }
    html = [];
    html.push("<ul>");
    if (realPath !== "./") {
      html.push('');
    }
    for (_i = 0, _len = files.length; _i < _len; _i++) {
      file = files[_i];
      _path = realPath + file;
      if (fs.statSync(realPath + file).isDirectory()) {
        _files = fs.readdirSync(_path);
        html.push("<li class='subdir'><span class='folder'></span><a href='javascript:void(0)'>" + file + (renderDir(_path, _files)) + "</a></li>");
      } else {
        html.push("<li><span class='file'></span><a href='./" + file + "'>" + file + "</a></li>");
      }
    }
    html.push("</ul>");
    return html.join("");
  };

  createServer = function(config) {
    var change, server, _i, _len, _path, _port, _ref;
    _path = config.path;
    _port = config.port;
    server = http.createServer(function(req, res) {
      var pathname, realPath;
      pathname = url.parse(req.url).pathname;
      realPath = _path + pathname;
      realPath = decodeURIComponent(realPath);
      /*
      		path exist
      */

      return fs.exists(realPath, function(exists) {
        var ext, sockets, _io, _ref, _sockets;
        if (!exists) {
          res.writeHead(404, {
            "Content-Type": "text/plain"
          });
          res.write("404 Not Found");
          return res.end();
        } else if (fs.statSync(realPath).isDirectory()) {
          return fs.readdir(realPath, function(err, files) {
            var _htmltext;
            if (err) {
              return res500(err, res);
            } else {
              res.writeHead(200, {
                "Content-Type": types["html"]
              });
              _htmltext = renderDir(realPath, files);
              res.write(insertTempl(_htmltext, [STYLE_TEMPLATE, SOCKET_TEMPLATE]));
              return res.end();
            }
          });
        } else {
          ext = path.extname(realPath);
          if (ext) {
            ext = ext.slice(1);
          } else {
            ext = "unknown";
          }
          res.setHeader("Content-Type", types[ext] || "text/plian");
          fs.readFile(realPath, "binary", function(err, file) {
            if (err) {
              return res500(err, res);
            } else {
              res.writeHead(200, "Ok");
              if (ext === "html" || ext === "htm") {
                file = insertSocket(file);
              }
              res.write(file, "binary");
              return res.end();
            }
          });
          _sockets = [];
          _io = (_ref = io.listen(server, {
            "log level": 0
          }), sockets = _ref.sockets, _ref);
          return sockets.on("connection", function(socket) {
            return _sockets.push(socket);
          });
        }
      });
    });
    _ref = ["fileCreated", "fileModified", "fileDeleted"];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      change = _ref[_i];
      watcher.on(change, function() {
        var socket, _j, _len1, _results;
        _results = [];
        for (_j = 0, _len1 = _sockets.length; _j < _len1; _j++) {
          socket = _sockets[_j];
          _results.push(socket.emit("reload"));
        }
        return _results;
      });
    }
    server.listen(_port);
    return console.log("f5 is on localhost:" + _port + " now.");
  };

  exports.version = "v0.0.3";

  exports.createServer = createServer;

}).call(this);
